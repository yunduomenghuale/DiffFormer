基于 Transformer 的深度扩散模型用于解析多组分 RNA 测序数据

摘要

多组分 RNA 测序（bulk RNA-seq）技术是测量组织样本中平均基因表达的有效手段，但其缺乏单细胞分辨率限制了对细胞异质性的深入理解。计算解卷积旨在从多组分数据中推断细胞类型比例，然而现有方法在复杂生物系统中的准确性仍有待提升。本文中，我们首次将扩散模型与 Transformer 架构相结合，提出了一种名为 “DiffFormer” 的新型深度学习模型，专门用于 RNA-seq 数据的解卷积分析。我们在四个不同来源的公开数据集（包括两个广泛使用的外周血单核细胞数据集 pbmc3k 和 pbmc68k，以及两个更为复杂的肝脏和胰腺组织数据集）上对 DiffFormer 进行了系统评估。结果显示，DiffFormer 在所有测试数据中均展现出一致且卓越的性能，显著优于多种传统基线和基于MLP的扩散模型（DiffMLP）。这项工作不仅提供了一个高精度、可复现的细胞解卷积工具，也证明了基于Transformer的生成模型在解决复杂生物信息学问题上的巨大潜力。

1. 引言

组织和器官是由多种不同功能的细胞类型组成的复杂系统。理解特定组织中细胞类型的组成对于揭示疾病机制、识别生物标志物和开发靶向疗法至关重要。多组分 RNA 测序（bulk RNA-seq）技术能够经济高效地提供组织样本的平均基因表达谱，已在生物医学研究中得到广泛应用。然而，这种 “平均化” 的测量方式掩盖了细胞层面的异质性，无法区分不同细胞类型的贡献。

近年来，单细胞 RNA 测序（scRNA-seq）技术的发展使得在单个细胞水平上解析基因表达成为可能，为我们提供了宝贵的细胞类型特异性基因表达参考图谱。计算解卷积（computational deconvolution）应运而生，它利用 scRNA-seq 提供的参考信息，从成本更低、更容易获得的 bulk RNA-seq 数据中反向推断出构成组织的各种细胞类型的相对丰度。

现有的解卷积方法，如基于非负最小二乘法的 CPM、基于稳健回归的 ADAPTS 和利用跨受试者信息的 MuSiC
，在许多场景下都取得了成功。然而，它们通常依赖于线性假设或特定的统计分布。这些假设在处理如肿瘤微环境（Tumor Microenvironment, TME）等高度异质性的样本时往往会失效。在这些复杂的场景中，细胞状态的连续性、细胞间的相互作用以及非线性的基因表达模式普遍存在，这使得传统方法难以捕捉数据中真实存在的复杂关系。

为了克服这些局限性，我们转向了深度学习。深度学习模型，特别是生成模型，具有强大的非线性特征提取能力。受近期在图像生成领域取得巨大成功的去噪扩散概率模型（DDPM）的启发，我们开发了一种新的解卷积框架。我们假设，细胞比例的预测过程可以被建模为一个从随机噪声逐渐去噪到真实比例的生成过程，而这个过程受到多组分基因表达谱的引导。

在本文中，我们提出 DiffFormer，这是一个基于 Transformer 架构的条件去噪扩散模型。我们之所以选择 Transformer，是因为基因表达谱可以被视为一种特殊的序列数据，其中不同基因之间可能存在复杂的长距离依赖关系。Transformer 核心的自注意力机制（self-attention）能够有效捕捉并建模这些全局依赖关系，这正是传统方法和标准神经网络所欠缺的。我们的模型将多组分表达谱作为条件，学习从一个随机噪声分布中恢复出精确的细胞类型比例。为了全面验证模型的性能和泛化能力，我们选取了四个具有代表性的数据集：两个经典的PBMC数据集（pbmc3k, pbmc68k）以及两个组织结构更复杂的肝脏（liver）和胰腺（pancreas）数据集，并在其上证明了DiffFormer相较于多种主流基线方法的优越性。

2. 方法

2.1 数据集与预处理

本研究使用了四个公开数据集，涵盖了从血液到实体器官的不同生物样本：

• **PBMC 数据集**: 使用了两个人外周血单核细胞（PBMC）数据集：pbmc3k 和 pbmc68k。对于 pbmc3k，我们根据其 louvain 聚类结果，将其注释为 8 种主要的免疫细胞类型。对于 pbmc68k，我们直接使用了其数据中包含的预注释细胞类型。

• **肝脏 (Liver) 数据集**: 这是一个来自人类肝脏组织的 scRNA-seq 数据集，包含了更为多样的细胞类型。

• **胰腺 (Pancreas) 数据集**: 该数据集来自于人类胰腺组织，其细胞组成和表达模式相比血液系统更为复杂。

在整个流程中，我们未对细胞类型进行额外的合并或细分处理，以保持其原始粒度。

数据获取与处理流程
我们为每个数据集构建了独立的、自动化的数据处理流水线，具体步骤如下：

•质量控制 (QC)：过滤掉低质量细胞，具体标准包括表达基因数过少或过多的细胞、线粒体基因比例过高的细胞；同时移除在极少数细胞中表达的基因。

•标准化：对基因表达计数进行库大小标准化，并应用 log1p 对数变换。处理中加入检查机制，避免对已对数化数据（如 pbmc68k 原始数据）重复变换，防止数据处理错误。

•高可变基因识别：筛选在不同细胞间表达差异最大的高可变基因（Highly Variable Genes, HVGs），减少计算维度并聚焦生物学关键信号。

伪多组分样本生成 (Pseudo-bulk Simulation)
为训练和评估模型，从处理后的 scRNA-seq 数据中生成具有已知细胞比例（ground truth）的伪多组分样本，模拟真实 bulk RNA-seq 的细胞混合效应，具体参数如下：

•细胞构成：每个伪多组分样本由固定的 2000 个单细胞构成。

•比例生成：通过狄利克雷分布（Dirichlet distribution）为每个样本生成随机细胞类型比例。

•样本生成：根据生成的比例，从相应细胞类型中随机抽样（有放回）足额细胞，将其基因表达谱平均构建伪多组分样本。

•数据集规模：为每个数据集生成 5000 个训练样本和 200 个测试样本。

通过此标准化模拟流程，我们为所有四个数据集构建了高质量的训练和测试数据，为后续的模型开发和综合评估奠定了坚实基础。

2.2 模型架构：从 DiffMLP 到 DiffFormer 的演进

我们的核心贡献是 DiffFormer，这是一个条件去噪扩散模型，其核心在于为去噪网络设计的基于 Transformer 的架构。

扩散模型框架
模型基于标准的去噪扩散概率模型（DDPM）框架：

前向过程 (扩散)：从真实细胞比例向量开始，通过T = 1000个时间步逐渐添加高斯噪声。任意时间步 t 的加噪过程遵循马尔可夫链，概率分布定义为：

其中为时间步 t 的噪声方差，采用线性调度策略，从线性增加到。

反向过程 (去噪)：学习去噪网络，在给定噪声向量和条件信息（多组分表达谱 c）时，预测添加到中的噪声。通过迭代减去预测噪声，从纯高斯噪声中恢复原始细胞比例。训练目标为最小化预测噪声与真实噪声的均方误差（MSE），损失函数定义为：

去噪网络的设计与演进
去噪网络性能直接决定解卷积精度，我们从基础设计逐步优化：

•初始尝试：基于 MLP 的去噪网络（DiffMLP）

采用标准多层感知机（MLP）作为去噪网络。模型的三个输入（噪声比例向量x_t、时间步 t、多组分表达谱 c）经各自嵌入层编码为特征向量后直接拼接，送入含多个隐藏层和非线性激活函数的 MLP，输出预测噪声。该方法虽理论上可拟合非线性关系，但难以捕捉不同模态输入间的复杂内在联系。

•最终方案：基于 Transformer 的 DiffFormer 模型

为克服 DiffMLP 的特征融合瓶颈，提出以 Transformer 编码器为去噪网络的 DiffFormer，具体配置如下：

◦模型维度 (model_dim)：128

◦注意力头数 (nhead)：4

◦编码器层数 (num_encoder_layers)：3

◦前馈网络维度 (dim_feedforward)：256

工作流程：

输入嵌入：三个输入（x_t, t, c）独立嵌入到 128 维特征空间，统一维度以适配 Transformer 的多模态输入处理。

序列构建与自注意力机制：将三个嵌入向量构建为序列 [proportion_embedding, time_embedding, bulk_embedding]，送入含 3 个层、4 个注意力头的 Transformer 编码器。自注意力机制动态计算序列元素间的重要性权重，深度建模不同输入来源的复杂依赖关系。

输出：取 Transformer 输出序列中与原始比例向量对应的第一个词元输出，通过线性层投影回目标维度以预测噪声。

通过从 DiffMLP 到 DiffFormer 的架构演进，证明了先进的序列关系建模架构对精准条件生成任务的重要性。

2.3 基线模型

为评估 DiffFormer 性能，选择三种经典解卷积方法作为基线：

•ADAPTS：基于稳健线性回归的方法。

•MuSiC：加权非负最小二乘法。

•CPM：基于支持向量回归的流行方法。

同时将 DiffMLP 作为内部对比项，展示模型架构演进过程。

2.4 模型训练与评估

训练配置
通过最小化损失函数 (2) 训练 DiffFormer 和 DiffMLP，分别在 pbmc3k, pbmc68k, liver, 和 pancreas 的伪多组分数据集上进行。伪多组分样本生成过程本身提供了大量多样化训练数据，未使用传统数据增强技术。训练在单个 NVIDIA A100 GPU 上完成，超参数配置如下：

•优化器：AdamW

•学习率：初始设置为 1e-4

•学习率调度：余弦退火策略（CosineAnnealingLR）

•批次大小：64

•训练轮次 (Epochs)：150

评估指标与稳定性
采用以下核心指标评估模型性能：

•均方根误差 (RMSE)：衡量预测与真实细胞比例的差异，值越低准确性越高。

•皮尔逊相关系数 (PCC)：衡量预测与真实比例的线性相关性，值越接近 1 趋势一致性越好。

通过分析测试集 RMSE 分布评估稳定性，紧凑的误差分布（小四分位距）表明模型在不同样本上的预测精度稳定。

2.5 可复现性分析

为确保研究透明度和可复现性，重构项目代码库，将通用参数化脚本拆分为数据集和任务专属脚本，覆盖所有四个数据集，例如：

•run_pbmc3k_processing.py, run_liver_processing.py ...

•run_pbmc3k_training.py, run_liver_training.py ...

•run_pbmc3k_deconvolution.py, run_liver_deconvolution.py ...

该结构提升了代码清晰度和可维护性，便于研究者复现所有实验结果。

3. 结果

我们系统评估了模型架构在四个基准数据集上的性能，围绕从 DiffMLP 到 DiffFormer 的架构演进展开，并与三种经典解卷积方法（ ADAPTS, MuSiC , CPM ）横向对比。

3.1 DiffFormer 在跨数据集对比中展现出一致的优越性

所有模型在四个数据集上的性能（以 RMSE 为指标）对比结果如图 1 所示，清晰揭示了架构选择对模型准确性的决定性影响。

[图 1：模型在全部四个数据集上的RMSE性能对比总览]

初始的 DiffMLP 模型性能与传统方法相当，甚至在某些情况下表现更差；而基于 Transformer 的 DiffFormer 经架构升级后，在所有四个数据集上均显著优于所有其他方法，证明了其强大的泛化能力。实验结果（表1）显示，DiffMLP 虽应用了先进的扩散框架，但其性能并未展现出深度学习应有的优势，其在四个数据集上的平均RMSE（0.1086, 0.1566, 0.1405, 0.0956）与Music、CPM等传统方法相比没有显著优势。然而，当去噪网络从简单的MLP升级为Transformer后，模型性能实现了质的飞跃。DiffFormer 的平均RMSE在所有数据集上稳定在0.011到0.015的极低水平，相较于DiffMLP，RMSE降低幅度达到了惊人的86%至92%。例如，在pbmc3k数据集上，RMSE从0.1086骤降至0.0124（降低88.6%）；在更复杂的胰腺数据集上，RMSE也从0.0956降至0.0130（降低86.4%）。这一从 “性能平平” 到 “全面超越” 的巨大反差，有力地证明了Transformer架构是模型取得成功的核心驱动力。

[表 1：所有模型在四个数据集上的平均RMSE和PCC]
(这里可以插入由上述数据生成的表格图片)

3.2 在 pbmc3k 数据集上的性能表现
我们在 pbmc3k 数据集上首先对模型性能进行了评估。结果清晰地表明， DiffFormer 在各项指标上均展现出压倒性的优势 (图 2)。从整体精度来看 (图 2A)， DiffFormer 的均方根误差 (RMSE) 中位数是所有模型中最低的，且其误差分布的箱体也最为紧凑，这表明 DiffFormer 的预测不仅准确度高，而且在不同样本间表现得非常稳定。值得注意的是， DiffFormer 模型的性能与 ADAPTS 、 CPM 等传统方法处于同一水平，这有力地证明了简单的网络结构即使在先进的扩散模型框架下也难以应对解卷积任务的复杂性。 DiffFormer 相较于 DiffFormer 在 RMSE 上的巨大提升，明确地将模型的成功归因于 Transformer 架构的应用。在更细致的、针对单个细胞类型的皮尔逊相关系数 (PCC) 评估中 (图 2B)， DiffFormer 同样表现卓越。对于数据集中包含的8种细胞类型， DiffFormer 和 ADAPTS 的预测值与真实值之间的相关性在绝大多数细胞上都最接近1，显著优于其他所有模型。
A
	B
图2：在 pbmc3k 数据集上的性能对比。* (A) 各模型在测试样本上的均方根误差 (RMSE) 分布。更低的RMSE代表更高的准确性。(B) 各模型对不同细胞类型预测的皮尔逊相关系数 (PCC) 热图。更接近1的值代表更强的相关性。

3.3 在 pbmc68k 数据集上的稳健性验证
为了验证我们模型的稳健性和可扩展性，我们在一个规模更大、细胞类型更多样化的 pbmc68k 数据集上重复了所有实验。结果表明， DiffFormer 的性能优势在该数据集上得到了完美的复现 (图 3)。尽管在 pbmc68k 这个更具挑战性的数据集上，所有模型的整体误差（RMSE）都有所上升，但 DiffFormer 的性能优势反而更加凸显，其 RMSE 水平显著低于所有竞争者 (图 3A)。同样，在细胞类型特异性的 PCC 分析中 (图 3B)， DiffFormer 依然在几乎所有细胞类型上都取得了最佳的相关性分数。这些在两个不同规模和复杂度的数据集上高度一致的结果，强有力地证明了 DiffFormer 不仅性能优越，而且具有出色的泛化能力和稳健性，是解决细胞解卷积任务的一个强大工具。
A
	B
图3：在 pbmc68k 数据集上的性能稳健性验证。* (A) RMSE分布图。(B) PCC热图。结果表明，DiffFormer的卓越性能在更复杂的数据集上依然成立。

3.4 在肝脏与胰腺数据集上的泛化能力验证

为了进一步检验 DiffFormer 在更复杂生物场景下的表现，我们将其应用于肝脏（liver）和胰腺（pancreas）数据集。这两个数据集代表了比血液系统结构更复杂、细胞类型更多样的实体组织。结果（图4）再次证实了 DiffFormer 的卓越性能和广泛适用性。

在肝脏和胰腺这两个挑战性数据集上，所有模型的整体误差（RMSE）均有不同程度的上升，这符合预期。然而，DiffFormer 的性能优势依然十分稳固，其RMSE值和误差分布的紧凑程度都显著优于所有对比模型。特别是在胰腺数据上，部分传统方法的性能出现了较大幅度的下降，而 DiffFormer 表现出强大的鲁棒性。同样，在细胞类型特异性的PCC分析中，DiffFormer 也在绝大多数细胞类型上取得了最接近1的相关性分数。

这些在总共四个不同组织来源、不同复杂度的数据集上取得的高度一致的优越结果，强有力地证明了 DiffFormer 不仅在标准基准上性能优越，更具备出色的泛化能力和稳健性，是解决真实世界复杂解卷积任务的一个强大且可靠的工具。

[图 4：在 liver 和 pancreas 数据集上的性能对比。 (A) liver数据集的RMSE和PCC图。(B) pancreas数据集的RMSE和PCC图。]

4. 讨论

本研究将条件去噪扩散模型与 Transformer 架构结合，应用于生物信息学的细胞解卷积问题，通过在四个多样化数据集上的全面评估，揭示了模型成功的关键因素。

作为一种高精度的解卷积工具，DiffFormer在解决实际生物学问题上展示出巨大潜力。外周血单核细胞（PBMC）作为机体免疫应答的核心组成部分，其细胞类型比例的动态变化与感染、自身免疫疾病及肿瘤免疫密切相关。DiffFormer 在 pbmc3k 和 pbmc68k 数据集上的高精度表现（平均PCC>0.99，相较于基线MLP模型RMSE降低超过85%），为免疫相关疾病的机制研究提供了关键工具。例如，在自身免疫性疾病（如类风湿关节炎）中，传统 bulk RNA-seq 往往只能检测到整体炎症基因的上调，而通过 DiffFormer 对 bulk 数据的解卷积分析，可精准识别出是 CD4+ T 细胞亚群比例升高还是巨噬细胞活化导致的免疫失衡，为靶向治疗提供细胞层面的具体靶点。此外，在肿瘤免疫治疗中，DiffFormer 能从外周血 bulk 数据中高效推断细胞毒性 T 细胞、调节性 T 细胞（Treg）的比例变化，动态监测治疗响应，避免了反复单细胞测序的高成本和技术复杂性。

同样，肝脏和胰腺作为结构复杂的实体器官，其细胞异质性与代谢疾病、癌症等密切相关。DiffFormer 在肝脏和胰腺数据集上的稳定性能（RMSE均在0.015左右），为这类疾病的研究突破提供了新可能。在肝脏疾病领域，慢性肝炎向肝硬化的进展伴随肝细胞、肝星状细胞、Kupffer 细胞等多种细胞类型的比例重构。DiffFormer 可通过肝组织 bulk RNA-seq 数据反推这些细胞的动态变化，例如精准量化肝星状细胞的激活比例，为肝纤维化的早期诊断和干预提供分子标志物。在胰腺研究中，胰腺导管腺癌（PDAC）的肿瘤微环境包含肿瘤细胞、基质细胞、免疫细胞等多种成分，传统方法难以解析其复杂构成。DiffFormer 对胰腺数据集的高分辨率解卷积（如对腺泡细胞、胰岛 β 细胞的 PCC 接近 1），可揭示肿瘤微环境中免疫抑制细胞（如 M2 型巨噬细胞）的浸润模式，为 PDAC 的免疫治疗联合策略提供理论依据。

DiffFormer 性能优越的原因包括：

•架构的内在差异是根本原因：我们的实验明确地将模型的成功归因于Transformer架构。虽然DiffFormer和DiffMLP接收完全相同的三个输入（带噪比例、时间步、表达谱），但它们处理信息的方式截然不同。DiffMLP通过简单的拼接(Concatenation)将所有信息扁平化为一个长向量，这削弱了不同信息来源的独立性。而DiffFormer则将这三者视为一个结构化的序列，利用其核心的自注意力机制来动态学习和权衡不同信息词元（Token）之间的复杂依赖关系，从而实现了更精准的条件生成。
•强大的非线性建模能力：扩散模型作为深度生成模型，可学习基因表达谱到细胞比例的高度非线性映射，超越依赖线性假设的传统方法。

•生成式框架的鲁棒性：将解卷积问题建模为生成过程，使模型学习细胞比例的内在分布结构，而非单纯回归预测，增强了对噪声和数据变化的鲁棒性。

研究局限性与未来方向：

•依赖高质量参考图谱：模型性能受 scRNA-seq 参考图谱质量影响。未来可探索结合扩散模型与参考图谱自适应优化方法，如利用半监督学习和无标签 bulk RNA-seq 数据迭代修正参考矩阵。

•数据集扩展需求：本研究已将验证扩展至四种不同的数据集，未来可进一步将模型应用于更多组织和疾病样本，尤其是在临床价值显著的场景（如 RNA 质量低、噪声大的 FFPE 样本）中验证其优势。

•模型效率与应用拓展：探索更高效的 Transformer 变体以加速训练和推理，并将框架扩展至空间转录组学解卷积等其他生物信息学问题。

5. 结论

本文提出并验证了新型解卷积模型 DiffFormer，该模型创新结合条件去噪扩散模型与 Transformer 架构，用于从多组分 RNA 测序数据中精确推断细胞类型比例。在横跨血液、肝脏和胰腺的四个公开数据集上的实验表明，DiffFormer 在准确性和相关性上显著优于现有基线方法。通过与 DiffMLP 的对比，证实了 Transformer 架构是其卓越性能的核心驱动力。这项工作不仅为细胞解卷积提供了高精度、可复现的工具，也为深度生成模型在生物医学领域的应用提供了新思路和坚实基线，可复现代码库将推动该领域的研究与应用。

6. 引用 